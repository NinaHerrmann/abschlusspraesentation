# User Story #1

> **Als Nutzer möchte ich OAuth 2.0 benutzen können, um Moodle Zugriff auf ownCloud zu gewähren.**

<div style="text-align: left; float: left; padding-left:5%;">
  <p><b>ownCloud-Administrator:</b></p>
  <ul>
    <li>Clientregistrierung</li>
    <li>Log-Einträge</li>
  </ul>

  <p><b>Client-Entwickler:</b></p>
  <ul>
    <li>Authorization URL</li>
    <li>Access Token URL</li>
    <li>Zugriff auf die WebDAV Schnittstelle</li>
    <li>Zugriff auf die OCS Share API</li>
  </ul>

  <p><b>ownCloud-Nutzer:</b></p>
  <ul>
    <li>Verwaltung autorisierter Applikationen</li>
  </ul>
</div>

<div style="text-align: left; float: right; padding-right:10%;">
  <p><b>Moodle-Administrator:</b></p>
  <ul>
    <li>Client-Daten verwalten</li>
    <li>Log-Einträge</li>
  </ul>
  <p><b>Moodle-Nutzer:</b></p>
  <ul>
    <li>Autorisierung von Moodle als Client</li>
  </ul>
</div>

---

# ownCloud

---

# Softwarearchitektur

<div align="left" style="padding-left:5%;">

* **OAuth 2.0 App:** <a href="https://github.com/owncloud/oauth2" target="_blank">owncloud/oauth2</a>
  * Implementierung des OAuth 2.0 Authorization Code Flow

* **ownCloud Core Anpassungen:** <a href="https://github.com/owncloud/core/pull/26742" target="_blank">owncloud/core#26742</a>
  * Ermöglichung eigener Authentifizierungsmethoden für
    * WebDAV
    * ownCloud APIs
      </br><span class="light">z. B.: OCS Share API</span>

---

# OAuth 2.0 App

---

# Authorization Code Flow

<div align="center">
	<img alt="Authorization Code Flow" src="images/owncloud/authorization-code-flow.svg" width=85%>
</div>

---

# Client Registrierung

<div align="left" style="padding-left:5%;">

* Der Administrator registriert die erlaubten Clients
  * Name des Clients
    </br><span class="light">z. B.: Learnweb</span>
  * Redirect URI
    </br><span class="light">z. B.: `https://www.learnweb.de/cb`</span>
  * Umgang mit Subdomains
    </br><span class="light">z. B.: Subdomains zulassen</span>
* Die App genertiert die Zugangsdaten des Clients
  * Client Identifier
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>
  * Client Secret
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>

---

# Authorization Request

<div align="left" style="padding-left:5%;">

* Der Client kann mit seinen Zugangsdaten eine Autorisierung anfragen
* Der Nutzer wird an die Authorization URL weitergeleitet </br><span class="light">`index.php/apps/oauth2/authorize`</span>
* URL Parameter:
	* `response_type`
    </br><span class="light">`code` für den Authorization Code Flow</span>
	* `client_id`
    </br><span class="light">siehe Client Registrierung</span>
	* `redirect_uri`
    </br><span class="light">siehe Client Registrierung</span>
	* `state`
    </br><span class="light">optional für die Wiedererkennung der Anfrage beim Client</span>
* Der Nutzer Authentifiziert sich und entscheidet über die Autorisierung

---

# Authorization Response

<div align="left" style="padding-left:5%;">

* Bei erfolgter Autorisierung leitet die App an die Redirect URI weiter
* URL Parameter:
  * `code`: Der ausgestellte Authorization Code
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>
  * `state`
    </br><span class="light">optional, falls bei Authorization Request angegeben</span>
* Ein Authorization Code ist für 10 Minuten gültig
* Abgelaufene Authorization Codes werden durch einen Background Job gelöscht

---

# Access Token Request

<div align="left" style="padding-left:5%;">

* Mit dem Authorization Code kann der Client ein Access Token anfordern
* Access Token URL: `/index.php/apps/oauth2/api/v1/token`
* URL Parameter:
	* `grant_type`
    </br><span class="light">entweder `authorization_code` oder `refresh_token`</span>
	* `code` und `redirect_uri`
    </br><span class="light">falls `grant_type = 'authorization_code'`</span>
	* `refresh_token`
    </br><span class="light">falls `grant_type = 'refresh_token'`</span>
* Zusätzliche Client Authentication mittels Basic Auth
  * Nutzername: Client Identifier
  * Passwort: Client Secret

---

# Access Token Response

<div align="left" style="padding-left:5%;">

* Bei gültigen Angaben wird ein Access Token mit Refresh Token ausgestellt

```json
{
    "access_token"  : "1vtnuo1NkIsbndAjVnhl7y0wJha59JyaAiFIVQDvcBY2uvKmj5EPBEhss0pauzdQ",
    "token_type"    : "Bearer",
    "expires_in"    : 3600,
    "refresh_token" : "7y0wJuvKmj5E1vjVnhlPBEhha59JyaAiFIVQDvcBY2ss0pauzdQtnuo1NkIsbndA",
    "user_id"       : "max"
}
```

* Ein Access Token ist für 1 Stunde gültig
* Abgelaufene Access Tokens werden durch einen Background Job gelöscht
* Mit einem Refresh Token kann ein neues Access Token angefordert werden

---

# Zusätzliche Funktionen

<div align="left" style="padding-left:5%;">

* Nutzer können in den persönlichen Einstellungen Autorisierungen widerrufen
* Die App wurde durch Integration von Transifex in über 10 Sprachen übersetzt
* Durch Logging kann sich der Administrator über Ereignisse informieren
  * Hinzugefügen bzw. Löschen von Clients
  * Ausstellung von Authorization Codes
  * Einlösung von Authorization Codes bzw. Refresh Tokens
  * Bereinigung der Datenbank von abgelaufenen Authorization Codes bzw. Access Tokens

---

# Authentifizierungslogik

<div align="left" style="padding-left:5%;">

* Abhängig vom Pull Request <a href="https://github.com/owncloud/core/pull/26742" target="_blank">owncloud/core#26742</a>

**WebDAV:**

* WebDAV ist als App mithilfe der Bibliothek sabre/dav implementiert
* Eigene Authentication Backends können hinzugefügt werden
* Registrierung in der OAuth 2.0 App durch Event Listener
  * In der WebDAV App ausgelöstes Event `authInit` kann dadurch angepasst weden
  * Notwendig dafür: Angabe des App-Typs `authentication`

**OCS Share API:**

* Implementierung eines `AuthModule`s
* Registrierung in der `info.xml`

```xml
<auth-modules>
  <module>OCA\OAuth2\AuthModule</module>
</auth-modules>
```

---

# Implementierungsdetails

<p class="todo">Ob diese Folie rein muss, weiß ich nicht.</p>

<div align="left" style="padding-left:5%;">

* Entities und Mapper ermöglichen den Zugriff auf die Datenbank vom PHP-Code aus
* Routes verbinden Schnittstellen mit Controllern
* Controller stellen die Logik bereit
* Templates definieren die Nutzer-Ansicht
* Hooks sorgen für das Löschen von veralteten Datenbank-Einträgen, wenn ein Nutzer gelöscht wurde

---

# ownCloud Core Anpassungen

---

# Moodle

---

# Protokollablauf

<div align="center">
	<img alt="Protokollablauf" src="images/owncloud/protokollablauf.svg" width=90%>
</div>
