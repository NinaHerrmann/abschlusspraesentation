# User Story #1

> **Als Nutzer möchte ich OAuth 2.0 benutzen können, um Moodle Zugriff auf ownCloud zu gewähren.**

<div style="text-align: left; float: left; padding-left:5%;">
  <p><b>ownCloud-Administrator:</b></p>
  <ul>
    <li>Clientregistrierung</li>
    <li>Log-Einträge</li>
  </ul>

  <p><b>Client-Entwickler:</b></p>
  <ul>
    <li>Authorization URL</li>
    <li>Access Token URL</li>
    <li>Zugriff auf die WebDAV Schnittstelle</li>
    <li>Zugriff auf die OCS Share API</li>
  </ul>

  <p><b>ownCloud-Nutzer:</b></p>
  <ul>
    <li>Verwaltung autorisierter Applikationen</li>
  </ul>
</div>

<div style="text-align: left; float: right; padding-right:10%;">
  <p><b>Moodle-Administrator:</b></p>
  <ul>
    <li>Clien-Daten verwalten</li>
    <li>Log-Einträge</li>
  </ul>
  <p><b>Moodle-Nutzer:</b></p>
  <ul>
    <li>Autorisierung von Moodle als Client</li>
  </ul>
</div>

---

# ownCloud

---

# Softwarearchitektur

<div align="left" style="padding-left:5%;">

**OAuth 2.0 App:** [owncloud/oauth2](https://github.com/owncloud/oauth2)

* Implementierung des OAuth 2.0 Authorization Code Flow

**Core Anpassungen:** [owncloud/core#26742](https://github.com/owncloud/core/pull/26742)

* Erweiterung der WebDAV Schnittstelle um OAuth 2.0
* Erweiterung der OCS Share API um OAuth 2.0

---

# OAuth 2.0 App

---

# Authorization Code Flow

<div align="center">
	<img alt="Authorization Code Flow" src="images/owncloud/authorization-code-flow.svg" width=85%>
</div>

---

# Client Registrierung

<div align="left" style="padding-left:5%;">

* Der Administrator registriert die erlaubten Clients
  * Name des Clients
    </br><span class="light">z. B.: Learnweb</span>
  * Redirect URI
    </br><span class="light">z. B.: `https://www.learnweb.de/cb`</span>
  * Umgang mit Subdomains
    </br><span class="light">z. B.: Subdomains zulassen</span>
* Die App genertiert die Zugangsdaten des Clients
  * Client Identifier
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>
  * Client Secret
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>

---

# Authorization Request

<div align="left" style="padding-left:5%;">

* Der Client kann mit seinen Zugangsdaten eine Autorisierung anfragen
* Der Nutzer wird an die Authorization URL weitergeleitet </br><span class="light">`index.php/apps/oauth2/authorize`</span>
* URL Parameter:
	* `response_type`
    </br><span class="light">`code` für den Authorization Code Flow</span>
	* `client_id`
    </br><span class="light">siehe Client Registrierung</span>
	* `redirect_uri`
    </br><span class="light">siehe Client Registrierung</span>
	* `state`
    </br><span class="light">optional für die Wiedererkennung der Anfrage beim Client</span>
* Der Nutzer Authentifiziert sich und entscheidet über die Autorisierung

---

# Authorization Response

<div align="left" style="padding-left:5%;">

* Bei erfolgter Autorisierung leitet die App an die Redirect URI weiter
* URL Parameter:
  * `code`: Der ausgestellte Authorization Code
    </br><span class="light">zufällige Zeichenkette mit 64 Zeichen</span>
  * `state`
    </br><span class="light">optional, falls bei Authorization Request angegeben</span>
* Ein Authorization Code ist für 10 Minuten gültig
* Abgelaufene Authorization Codes werden durch einen Background Job gelöscht

---

# Access Token Request

<div align="left" style="padding-left:5%;">

* Mit dem Authorization Code kann der Client ein Access Token anfordern
* Access Token URL: `/index.php/apps/oauth2/api/v1/token`
* URL Parameter:
	* `grant_type`
    </br><span class="light">entweder `authorization_code` oder `refresh_token`</span>
	* `code` und `redirect_uri`
    </br><span class="light">falls `grant_type = 'authorization_code'`</span>
	* `refresh_token`
    </br><span class="light">falls `grant_type = 'refresh_token'`</span>
* Zusätzliche Client Authentication mittels Basic Auth
  * Nutzername: Client Identifier
  * Passwort: Client Secret

---

# Access Token Response

<div align="left" style="padding-left:5%;">

* Bei gültigen Angaben wird ein Access Token mit Refresh Token ausgestellt

```json
{
    "access_token"  : "1vtnuo1NkIsbndAjVnhl7y0wJha59JyaAiFIVQDvcBY2uvKmj5EPBEhss0pauzdQ",
    "token_type"    : "Bearer",
    "expires_in"    : 3600,
    "refresh_token" : "7y0wJuvKmj5E1vjVnhlPBEhha59JyaAiFIVQDvcBY2ss0pauzdQtnuo1NkIsbndA",
    "user_id"       : "max"
}
```

* Ein Access Token ist für 1 Stunde gültig
* Abgelaufene Access Tokens werden durch einen Background Job gelöscht
* Mit einem Refresh Token kann ein neues Access Token angefordert werden

---

# Implementierungsdetails

* Entities und Mapper
* Schnittstellen und Routes
* Controller
* Templates

---

# Moodle

---

# Protokollablauf

<div align="center">
	<img alt="Protokollablauf" src="images/owncloud/protokollablauf.svg" width=90%>
</div>
